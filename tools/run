#!/bin/bash
# Run a tool with auto-restart on code changes (via Flask debug mode)
# Output is visible and logged to output/logs/tools/

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
LOG_DIR="$PROJECT_DIR/output/logs/tools"

if [ -z "$1" ]; then
    echo "Usage: tools/run <tool_name>"
    echo ""
    echo "Available tools:"
    for f in "$SCRIPT_DIR"/*.py; do
        [ -f "$f" ] && basename "$f" .py
    done | grep -v __init__ | sed 's/^/  /'
    exit 1
fi

TOOL="$1"
TOOL_PATH="$SCRIPT_DIR/${TOOL}.py"

if [ ! -f "$TOOL_PATH" ]; then
    echo "Error: Tool not found: $TOOL_PATH"
    exit 1
fi

# Create log directory
mkdir -p "$LOG_DIR"

# Generate log filename with timestamp
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
LOG_FILE="$LOG_DIR/${TOOL}_${TIMESTAMP}.log"

echo "Starting $TOOL..."
echo "Output will appear below. Flask debug mode will auto-restart on code changes."
echo "Log file: $LOG_FILE"
echo "---"
export PYTHONUNBUFFERED=1
uv run --script "$TOOL_PATH" 2>&1 | tee "$LOG_FILE"
